<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>KAPI RUN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">

  <link rel="manifest" href="appmanifest.json">
  <link rel="apple-touch-icon" sizes="128x128" href="icons/icon-128.png">
  <link rel="apple-touch-icon" sizes="256x256" href="icons/icon-256.png">
  <link rel="icon" type="image/png" href="icons/icon-256.png">

  <link rel="stylesheet" href="style.css">

  <style>
    /* Skor rozeti (canlı gösterim) */
    #score-display {
      position: fixed; top: 12px; left: 12px;
      background: rgba(0,0,0,.6); color: #fff;
      padding: 6px 12px; border-radius: 8px;
      font: 700 14px/1.4 system-ui, Arial;
      z-index: 99999;
      backdrop-filter: blur(2px);
    }
  </style>
</head>
<body>
  <div id="fb-root"></div>

  <!-- Canlı skor rozeti -->
  <div id="score-display">Score: 0</div>

  <!-- Oyun dosyaların -->
  <script src="scripts/supportcheck.js"></script>
  <script src="scripts/offlineclient.js" type="module"></script>
  <script src="scripts/main.js" type="module"></script>
  <script src="scripts/register-sw.js" type="module"></script>

  <!-- Telegram Games SDK -->
  <script src="https://telegram.org/js/games.js"></script>

  <script>
    // URL fragment (#u=...&c=...&m=...&t=...) içinden parametreleri al
    const params = new URLSearchParams(location.hash.slice(1));
    const user_id    = params.get('u');
    const chat_id    = params.get('c');
    const message_id = params.get('m');
    const token      = params.get('t');

    const scoreBox = document.getElementById('score-display');
    let score = 0;

    // ----- Skor gönderme -----
    async function submitScore(finalScore) {
      try {
        if (!user_id || !chat_id || !message_id || !token) {
          console.warn("Not in Telegram context; skipping score submit.");
          return;
        }
        const res = await fetch('/api/score', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ user_id, chat_id, message_id, token, score: Number(finalScore)||0 })
        });
        const j = await res.json().catch(() => ({}));
        if (!res.ok || !j.ok) console.error('Score submit failed:', j);
        else console.log("Score submitted:", finalScore);
      } catch (e) {
        console.error('Score submit error:', e);
      }
    }
    window.submitScore = submitScore; // global erişim

    // ----- Canlı skor UI güncelleme -----
    function updateScore(newScore){
      score = Number(newScore) || 0;
      if (scoreBox) scoreBox.textContent = "Score: " + score;
    }
    window.updateScore = updateScore; // oyun içinden de çağrılabilir

    // ----- Construct runtime hook: otomatik skor polling -----
    (function hookC3RuntimeAndAutoScore(){
      function attachHook(){
        try {
          if (!self.C3_CreateRuntime || self.C3_CreateRuntime.__wrapped) return false;

          const origCreate = self.C3_CreateRuntime;
          self.C3_CreateRuntime = function(cfg){
            const rt = origCreate(cfg);
            try {
              window.__c3rt = rt;

              // Skor okuma fonksiyonu
              window.getScore = function(){
                try {
                  if (rt && rt.globalVars && typeof rt.globalVars.Score !== 'undefined') {
                    return Number(rt.globalVars.Score) || 0;
                  }
                  return 0;
                } catch(e) { return 0; }
              };

              // 300ms'de bir skoru kontrol et
              let lastScore = -1;
              setInterval(() => {
                const s = (window.getScore && window.getScore()) || 0;
                if (s !== lastScore) {
                  lastScore = s;
                  if (window.updateScore) window.updateScore(s);
                }
              }, 300);
            } catch(e) {}
            return rt;
          };
          self.C3_CreateRuntime.__wrapped = true;
          return true;
        } catch(e) { return false; }
      }

      if (!attachHook()){
        let tries = 0;
        const iv = setInterval(() => {
          tries++;
          if (attachHook() || tries > 50) clearInterval(iv);
        }, 100);
      }
    })();

    // Klavye kısayolu (test): S tuşu → 123 skor gönder
    document.addEventListener('keydown', e => {
      if (e.key.toLowerCase() === 's') submitScore(123);
    });

    // (Opsiyonel) Telegram WebApp görünümü uyumu
    if (window.Telegram && Telegram.WebApp) {
      Telegram.WebApp.expand();
      Telegram.WebApp.ready();
    }
  </script>
</body>
</html>
