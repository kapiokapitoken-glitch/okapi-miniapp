<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>KAPI RUN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">

  <link rel="manifest" href="appmanifest.json">
  <link rel="apple-touch-icon" sizes="128x128" href="icons/icon-128.png">
  <link rel="apple-touch-icon" sizes="256x256" href="icons/icon-256.png">
  <link rel="icon" type="image/png" href="icons/icon-256.png">

  <link rel="stylesheet" href="style.css">

  <style>
    /* Canlı skor rozeti */
    #score-display {
      position: fixed; top: 12px; left: 12px;
      background: rgba(0,0,0,.6); color: #fff;
      padding: 6px 12px; border-radius: 8px;
      font: 700 14px/1.4 system-ui, Arial;
      z-index: 99999;
      backdrop-filter: blur(2px);
      user-select: none;
      -webkit-user-select: none;
    }
    /* Hızlı test butonu (mobil için) */
    #kr-debug {
      position: fixed; right: 12px; bottom: 12px; z-index: 99999;
      padding: 10px 14px; border: 0; border-radius: 10px;
      background: #0a84ff; color: #fff; font-size: 14px;
      display: none;
    }
  </style>
</head>
<body>
  <div id="fb-root"></div>

  <!-- Canlı skor rozeti -->
  <div id="score-display">Score: 0</div>
  <!-- Hızlı test: ?debug=1 ile görünür -->
  <button id="kr-debug">Test Skor (123)</button>

  <!-- Oyun dosyaların -->
  <script src="scripts/supportcheck.js"></script>
  <script src="scripts/offlineclient.js" type="module"></script>
  <script src="scripts/main.js" type="module"></script>
  <script src="scripts/register-sw.js" type="module"></script>

  <!-- Telegram Games SDK -->
  <script src="https://telegram.org/js/games.js"></script>

  <script>
    // URL fragment (#u=...&c=...&m=...&t=...) içinden parametreleri al
    const params = new URLSearchParams(location.hash.slice(1));
    const user_id    = params.get('u');
    const chat_id    = params.get('c');
    const message_id = params.get('m');
    const token      = params.get('t');

    const scoreBox = document.getElementById('score-display');
    const debugBtn = document.getElementById('kr-debug');

    // ----- Skor gönderme köprüsü (global) -----
    async function submitScore(finalScore, username) {
      try {
        if (!user_id || !chat_id || !message_id || !token) {
          console.warn("[KAPI] Not in Telegram context; skipping score submit.");
          return false;
        }
        const res = await fetch('/api/score', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            user_id: Number(user_id),
            chat_id: Number(chat_id),
            message_id: Number(message_id),
            token,
            score: Number(finalScore)||0,
            username: username || null
          })
        });
        const j = await res.json().catch(() => ({}));
        if (!res.ok || !j.ok) {
          console.error('[KAPI] Score submit failed:', j);
          return false;
        }
        console.log('[KAPI] Score submitted:', finalScore);
        return true;
      } catch (e) {
        console.error('[KAPI] Score submit error:', e);
        return false;
      }
    }
    window.submitScore = submitScore;         // mevcut ad
    window.KAPI_sendScore = submitScore;      // alternatif ad

    // ----- Canlı skor UI güncelleme (global) -----
    let score = 0;
    function updateScore(newScore){
      score = Number(newScore) || 0;
      if (scoreBox) scoreBox.textContent = "Score: " + score;
    }
    window.updateScore = updateScore;

    // ----- Construct runtime hook: skor takibi + otomatik gönderim -----
    (function hookC3RuntimeAndAutoScore(){
      let lastScore   = -1;
      let lastPeak    = 0;
      let idleTicks   = 0;
      let inRun       = false;
      let submitted   = false;

      function maybeSubmit(reason){
        if (!inRun || submitted || lastPeak <= 0) return;
        submitted = true;
        console.log('[KAPI] Auto submit by', reason, 'peak=', lastPeak);
        submitScore(lastPeak);
      }

      function resetRunState(){
        lastScore = -1;
        lastPeak = 0;
        idleTicks = 0;
        inRun = false;
        submitted = false;
      }

      // Construct runtime'a wrap
      function attachHook(){
        try {
          if (!self.C3_CreateRuntime || self.C3_CreateRuntime.__wrapped) return false;

          const origCreate = self.C3_CreateRuntime;
          self.C3_CreateRuntime = function(cfg){
            const rt = origCreate(cfg);
            try {
              window.__c3rt = rt;

              // Skor okuma fonksiyonu
              window.getScore = function(){
                try {
                  if (rt && rt.globalVars && typeof rt.globalVars.Score !== 'undefined') {
                    return Number(rt.globalVars.Score) || 0;
                  }
                  return 0;
                } catch(e) { return 0; }
              };

              // 300ms'de bir skoru kontrol et, GameOver tespiti yap
              setInterval(() => {
                const s = (window.getScore && window.getScore()) || 0;

                // UI güncelle
                if (s !== lastScore) {
                  if (window.updateScore) window.updateScore(s);
                }

                // Run durumu ve pik skor
                if (s > 0) {
                  inRun = true;
                  lastPeak = Math.max(lastPeak, s);
                }

                // GameOver olabilecek global değişken isimleri
                let gv = rt && rt.globalVars;
                let go = false;
                try {
                  if (gv) {
                    go = (gv.GameOver === 1 || gv.GameOver === true ||
                          gv.IsGameOver === 1 || gv.Game_Over === 1 ||
                          gv.dead === 1 || gv.Dead === 1);
                  }
                } catch(e){}

                // Skor değişmiyorsa idle sayaç
                if (s === lastScore) {
                  idleTicks++;
                } else {
                  idleTicks = 0;
                }

                // Olası GameOver tetikleyicileri:
                // 1) GameOver flag'i
                if (go && inRun && !submitted) {
                  maybeSubmit('flag');
                }
                // 2) Skor uzun süre değişmiyorsa (3 sn ~ 10 tick)
                if (idleTicks >= 10 && inRun && !submitted) {
                  maybeSubmit('idle');
                }
                // 3) Skor 0'a döndüyse ve daha önce koşu olduysa (reset)
                if (s === 0 && lastScore > 0 && inRun && !submitted) {
                  // küçük gecikme ile teyit
                  setTimeout(() => { maybeSubmit('reset-to-zero'); }, 200);
                }

                // Yeni koşu için reset şartları:
                // gönderim yapılmış ve skor 0 ise tam reset
                if (submitted && s === 0) {
                  resetRunState();
                }

                lastScore = s;
              }, 300);
            } catch(e) { console.warn('[KAPI] Hook error', e); }
            return rt;
          };
          self.C3_CreateRuntime.__wrapped = true;
          return true;
        } catch(e) { return false; }
      }

      if (!attachHook()){
        let tries = 0;
        const iv = setInterval(() => {
          tries++;
          if (attachHook() || tries > 50) clearInterval(iv);
        }, 100);
      }
    })();

    // Klavye kısayolu (masaüstü test): S → 123 skor gönder
    document.addEventListener('keydown', e => {
      if (e.key.toLowerCase() === 's') submitScore(123);
    });

    // Mobil: ?debug=1 ile "Test Skor" butonunu göster
    (function showDebugIfRequested(){
      const inTelegram = !!(user_id && chat_id && message_id && token);
      const debug = new URLSearchParams(location.search).get('debug') === '1';
      if (inTelegram && debug && debugBtn) {
        debugBtn.style.display = 'block';
        debugBtn.onclick = async () => {
          const ok = await submitScore(123);
          alert(ok ? 'Skor gönderildi ✅' : 'Gönderilemedi ❌');
        };
      }
    })();

    // (Opsiyonel) Telegram WebApp görünümü uyumu
    if (window.Telegram && Telegram.WebApp) {
      try { Telegram.WebApp.expand(); Telegram.WebApp.ready(); } catch(_){}
    }
  </script>
</body>
</html>
