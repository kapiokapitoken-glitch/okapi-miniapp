<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>KAPI RUN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" />

  <link rel="manifest" href="appmanifest.json">
  <link rel="apple-touch-icon" sizes="128x128" href="icons/icon-128.png">
  <link rel="apple-touch-icon" sizes="256x256" href="icons/icon-256.png">
  <link rel="icon" type="image/png" href="icons/icon-256.png">
  <link rel="stylesheet" href="style.css">

  <style>
    html, body { height:100%; margin:0; background:#000; overflow:hidden; }
    #score-display{
      position:fixed; top:12px; left:12px; z-index:99999;
      padding:6px 12px; border-radius:8px; color:#fff; background:rgba(0,0,0,.6);
      font:700 14px/1.4 system-ui, Arial; user-select:none; -webkit-user-select:none; backdrop-filter:blur(2px);
    }
    #kr-fullscreen{
      position:fixed; right:12px; top:12px; z-index:99999;
      padding:8px 12px; border:0; border-radius:10px; cursor:pointer;
      background:#10b981; color:#081c15; font:700 13px system-ui,Arial; box-shadow:0 4px 14px rgba(0,0,0,.15);
    }
    #fs-hint{
      position:fixed; inset:0; display:none; place-items:center; z-index:99998;
      background:rgba(0,0,0,.55); color:#fff; font:600 16px/1.6 system-ui,Arial; text-align:center; padding:24px;
    }
    #kr-inspector{ position:fixed; right:12px; bottom:70px; z-index:99999; display:none;
      width:min(92vw,420px); max-height:60vh; overflow:auto; background:rgba(0,0,0,.85); color:#fff;
      border-radius:12px; padding:10px; }
    #kr-inspector h3{ margin:0 0 8px 0; font:700 14px system-ui,Arial; }
    #kr-inspector .item{ display:flex; justify-content:space-between; align-items:center;
      padding:8px; margin-bottom:6px; border-radius:8px; background:rgba(255,255,255,.06); cursor:pointer; }
    #kr-inspector .item.active{ outline:2px solid #10b981; }
  </style>

  <!-- 🔹 KAPI RUN Hook & Score -->
  <script>
    const VER = '20250908'; // cache-bust etiketi

    const _p = new URLSearchParams(location.hash.slice(1));
    const _uid=_p.get('u'), _cid=_p.get('c'), _mid=_p.get('m'), _tok=_p.get('t');

    function updateScore(n){
      const box=document.getElementById('score-display');
      if(box) box.textContent="$OKAPI: "+(Number(n)||0);
    }
    window.updateScore=updateScore;

    async function submitScore(score, username){
      try{
        if(!_uid||!_cid||!_mid||!_tok){console.warn('[KAPI] Not in Telegram context');return false;}
        const res=await fetch('/api/score',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({user_id:+_uid,chat_id:+_cid,message_id:+_mid,token:_tok,score:+score||0,username:username||null})
        });
        const j=await res.json().catch(()=>({}));
        if(!res.ok||!j.ok){console.error('[KAPI] score fail',j);return false;}
        console.log('[KAPI] score ok',score);return true;
      }catch(e){console.error('[KAPI] score err',e);return false;}
    }
    window.submitScore=submitScore;
    window.KAPI_reportScore=n=>updateScore(n);

    // Runtime hook
    let SCORE_KEY=null;const CANDS=['NEWSCORE','Score','SCORE','Skor','Puan','BESTSCORE','OKAPI','Coins'];
    const _state={rt:null,lastVals:{},lastShow:-1,peak:0,inRun:false,submitted:false,idle:0};
    function initRuntime(rt){
      if(!rt||_state.rt) return;_state.rt=rt;window.__c3rt=rt;buildInspector();
      setInterval(()=>{
        const gv=(rt&&rt.globalVars)?rt.globalVars:{};let val=NaN;
        if(SCORE_KEY&&typeof gv[SCORE_KEY]!=='undefined'){val=+gv[SCORE_KEY];}
        else{for(const k of CANDS){if(typeof gv[k]!=='undefined'){const v=+gv[k];if(!Number.isNaN(v)){val=v;SCORE_KEY=k;break;}}}}
        for(const [k,v] of Object.entries(gv)){const n=+v;if(!Number.isNaN(n))_state.lastVals[k]=n;}
        if(!Number.isNaN(val)){
          if(val!==_state.lastShow){_state.lastShow=val;updateScore(val);_state.idle=0;}else{_state.idle++;}
          if(val>0){_state.inRun=true;_state.peak=Math.max(_state.peak,val);}
          if(_state.idle>=10&&_state.inRun&&!_state.submitted){_state.submitted=true;submitScore(_state.peak);}
          if(_state.submitted&&val===0){_state.inRun=false;_state.submitted=false;_state.peak=0;_state.idle=0;}
        }
      },300);
    }
    (function(){
      const wrap=()=>{if(!self.C3_CreateRuntime)return false;if(self.C3_CreateRuntime.__wrapped)return true;
        const orig=self.C3_CreateRuntime;self.C3_CreateRuntime=function(cfg){const rt=orig(cfg);try{initRuntime(rt);}catch(e){}return rt;};
        self.C3_CreateRuntime.__wrapped=true;return true;};
      if(!wrap()){let tries=0;const iv=setInterval(()=>{tries++;if(wrap()||tries>50)clearInterval(iv);},100);}
    })();
  </script>
</head>

<body>
  <div id="score-display">$OKAPI: 0</div>
  <button id="kr-fullscreen">TAM EKRAN</button>
  <div id="fs-hint">Tam ekran için bir kez dokun / tıkla</div>
  <div id="kr-inspector"></div>

  <!-- Construct uyumluluk kontrolleri -->
  <script src="scripts/modernjscheck.js?v=20250908"></script>
  <script src="scripts/supportcheck.js?v=20250908"></script>
  <script src="scripts/c3runtime.js?v=20250908"></script>
  <script src="scripts/c3main.js?v=20250908"></script>

  <!-- ⚠️ SW şimdilik kapalı -->
  <!-- <script type="module" src="scripts/offlineclient.js?v=20250908"></script> -->
  <!-- <script type="module" src="scripts/register-sw.js?v=20250908"></script> -->

  <!-- Telegram Games SDK -->
  <script src="https://telegram.org/js/games.js"></script>

  <script>
    (function(){
      const fsBtn=document.getElementById('kr-fullscreen');
      const fsHint=document.getElementById('fs-hint');
      const isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      async function tryFullscreen(){
        const el=document.documentElement;const req=el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen;
        if(req){try{await req.call(el);fsHint.style.display='none';}catch(_){ }}
      }
      if(isMobile){fsBtn.style.display='none';}
      else{
        const wantFs=new URLSearchParams(location.search).get('fs')==='1';
        if(wantFs){fsHint.style.display='grid';tryFullscreen();window.addEventListener('pointerdown',()=>tryFullscreen(),{once:true});
          document.addEventListener('fullscreenchange',()=>{if(document.fullscreenElement)fsHint.style.display='none';});}
        fsBtn.addEventListener('click',()=>{
          const base=location.origin+location.pathname;
          const qs=new URLSearchParams(location.search);qs.set('fs','1');
          const url=base+'?'+qs.toString()+location.hash;
          const w=window.open(url,'_blank','noopener');if(!w)location.href=url;
        });
      }
    })();
  </script>
</body>
</html>
