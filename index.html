<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Kapi Runner ‚Äî Pixel</title>
<style>
  html,body{margin:0;padding:0;background:#0f1226;height:100%;overflow:hidden;font-family:system-ui,Arial}
  #ui{position:fixed;left:0;right:0;top:0;display:flex;align-items:center;justify-content:space-between;padding:8px 12px;color:#fff;z-index:3}
  #left{display:flex;gap:10px;align-items:center}
  .pill{background:rgba(255,255,255,.12);border-radius:999px;padding:6px 10px}
  #btnStart{background:#6c5ce7;border:0;color:#fff;padding:8px 12px;border-radius:10px}
  #hint{position:fixed;left:50%;top:58%;transform:translate(-50%,-50%);color:#fff;opacity:.95;font-size:15px;text-align:center;z-index:2}
  canvas{display:block;touch-action:none}
</style>
</head>
<body>
<div id="ui">
  <div id="left">
    <div class="pill">‚ù§Ô∏è <span id="lives">3</span></div>
    <div class="pill">‚≠ê <span id="score">0</span></div>
  </div>
  <button id="btnStart">Ba≈ülat</button>
</div>
<div id="hint">Dokun / Space: Zƒ±pla ‚¨ÜÔ∏è<br/>Engelleri a≈ü, coin topla!</div>
<canvas id="game"></canvas>

<script>
var tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
try { if (tg && typeof tg.expand === 'function') tg.expand(); } catch (e) {}

const cvs = document.getElementById("game");
const ctx = cvs.getContext("2d");
function fit(){
  const w = Math.min(window.innerWidth, 420);
  const h = Math.min(window.innerHeight, 780);
  const dpr = window.devicePixelRatio || 1;
  cvs.style.width = w+"px"; cvs.style.height = h+"px";
  cvs.width = Math.floor(w*dpr); cvs.height = Math.floor(h*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.imageSmoothingEnabled = false;
}
fit(); addEventListener("resize", fit);
const W = ()=>cvs.clientWidth, H = ()=>cvs.clientHeight;

let running=false, over=false, score=0, best=0, lives=3;
let speed=3.0, t=0;
let kapi, obstacles=[], coins=[], clouds=[], groundX=0;

const G = 0.55, JUMP = -9.8, COYOTE = 110, GROUND_H = 72;
const SPAWN_OBS = [900,1400], SPAWN_COIN= [700,1100];

let last = 0, nextObs = 600, nextCoin = 400, lastOnGround = 0;
const R = (a,b)=> a + Math.random()*(b-a);

/* --- Pixel-art sprite at√∂lyesi (offscreen) --- */
const PX = 48;
function makePx(){
  const c = document.createElement("canvas");
  c.width = c.height = PX;
  const p = c.getContext("2d"); p.imageSmoothingEnabled = false;
  const rect=(x,y,w,h,f)=>{ p.fillStyle=f; p.fillRect(Math.round(x),Math.round(y),Math.round(w),Math.round(h)); };
  const circ=(x,y,r,f)=>{ p.fillStyle=f; p.beginPath(); p.arc(x,y,r,0,Math.PI*2); p.fill(); };
  return {c,p,rect,circ};
}
function kapiFrames(){
  const frames=[];
  for(let i=0;i<4;i++){
    const {c,p,rect,circ} = makePx(); p.clearRect(0,0,PX,PX);
    rect(18,20,20,14,"#8d5a2b"); rect(22,26,12,10,"#c68a53"); rect(30,14,10,10,"#8d5a2b"); // g√∂vde-kafa
    rect(34,8,8,8,"#a56a36"); rect(33,10,3,4,"#c68a53"); // kulak
    rect(36,16,2,2,"#1b1b1b"); // g√∂z
    rect(20,18,16,4,"#e74c3c"); rect(12,18+[-5,-2,1,-3][i],10,4,"#e74c3c"); // atkƒ±
    rect(18,24+[-4,0,4,0][i],12,6,"#f3c97a"); // kanat
    rect(22,33,4,6+[0,3,6,3][i],"#5d3b1a"); rect(30,33,4,6+[6,3,0,3][i],"#5d3b1a"); // bacak
    frames.push(c);
  }
  return frames;
}
function coinFrames(){
  const frames=[]; for(let i=0;i<4;i++){
    const {c,p,rect,circ} = makePx(); p.clearRect(0,0,PX,PX);
    circ(24,24,12,"#ffd23f"); p.save(); p.translate(24,24); p.rotate(i*(Math.PI/8)+0.2);
    rect(-2,-12,4,24,"#ffb703"); p.restore(); frames.push(c);
  } return frames;
}
function groundTile(){
  const {c,p,rect} = makePx(); rect(0,16,48,32,"#693d15"); rect(0,16,48,6,"#2ecc71");
  rect(6,34,6,4,"rgba(255,255,255,.06)"); rect(20,28,8,5,"rgba(255,255,255,.06)"); rect(32,36,7,5,"rgba(255,255,255,.06)");
  return c;
}
function cloudTile(){
  const {c,p} = makePx(); p.fillStyle="rgba(255,255,255,.95)";
  p.beginPath(); p.arc(18,20,12,0,Math.PI*2); p.fill();
  p.beginPath(); p.arc(28,22,10,0,Math.PI*2); p.fill();
  p.beginPath(); p.arc(24,16,9,0,Math.PI*2); p.fill(); return c;
}
const KAPI_FR = kapiFrames(), COIN_FR = coinFrames(), T_GROUND = groundTile(), T_CLOUD = cloudTile();

/* Kapi nesnesi */
function resetKapi(){
  kapi = {
    x: 80, y: H()-GROUND_H-42, vy: 0, onGround: true, frame:0, ftime:0, scale:2.2,
    flap(){ const now=performance.now(); if(this.onGround || (now-lastOnGround)<COYOTE){ this.vy=JUMP; this.onGround=false; } },
    step(dt){
      this.vy += G; this.y += this.vy;
      const floor = H()-GROUND_H-42;
      if (this.y>=floor){ this.y=floor; this.vy=0; if(!this.onGround) lastOnGround=performance.now(); this.onGround=true; }
      this.ftime+=dt; if(this.ftime>70){ this.ftime=0; this.frame=(this.frame+1)%KAPI_FR.length; }
    },
    draw(){ const s=this.scale; ctx.drawImage(KAPI_FR[this.frame], this.x-24*s/2, this.y-24*s/2, 48*s, 48*s); }
  };
}

let obstacles=[], coins=[], clouds=[];
function spawnObstacle(){ const h= (20+Math.random()*22)*1.6, w=(22+Math.random()*12)*1.2; obstacles.push({x:W()+30,y:H()-GROUND_H-h,w,h}); nextObs = R(...SPAWN_OBS); }
function spawnCoin(){ const y= H()-GROUND_H-(60+Math.random()*100); coins.push({x:W()+30,y,r:10,frame:0,ftime:0,taken:false,scale:1.6}); nextCoin=R(...SPAWN_COIN); }
function ensureClouds(){ while(clouds.length<6){ clouds.push({x:R(0,W()), y:R(30,H()-GROUND_H-180), s:R(.2,.7), w:R(60,140)}); } }

function drawBg(dt){
  const g=ctx.createLinearGradient(0,0,0,H()); g.addColorStop(0,"#1a2150"); g.addColorStop(1,"#0f1226"); ctx.fillStyle=g; ctx.fillRect(0,0,W(),H());
  clouds.forEach(c=>{ c.x -= c.s*speed*0.7; if(c.x<-c.w){ c.x=W()+c.w; c.y=R(20,H()-GROUND_H-200); } ctx.drawImage(T_CLOUD, c.x, c.y, c.w, 38); });
}
function drawGround(){ groundX -= speed*1.2; if(groundX<=-24) groundX+=24; for(let x=groundX; x<W()+24; x+=24){ ctx.drawImage(T_GROUND, x, H()-GROUND_H, 24, GROUND_H); } }
function drawObs(){ ctx.fillStyle="#27ae60"; obstacles.forEach(o=>{ ctx.fillRect(o.x,o.y,o.w,o.h); ctx.strokeStyle="#145a32"; ctx.lineWidth=3; ctx.strokeRect(o.x,o.y,o.w,o.h); }); }
function drawCoins(dt){ coins.forEach(c=>{ if(c.taken) return; c.ftime+=dt; if(c.ftime>90){ c.ftime=0; c.frame=(c.frame+1)%COIN_FR.length; } const s=c.scale; ctx.drawImage(COIN_FR[c.frame], c.x-24*s/2, c.y-24*s/2, 48*s,48*s); }); }

const hitRect = o => { const rx=kapi.x, ry=kapi.y, rr=20; return (rx+rr>o.x && rx-rr<o.x+o.w && ry+rr>o.y && ry-rr<o.y+o.h); };
const hitCoin = c => { const dx=kapi.x-c.x, dy=kapi.y-c.y; return (dx*dx+dy*dy)<(22*22); };

function loop(ts){
  if(!last) last=ts;
  const dt=ts-last; last=ts;

  if(running && !over){
    t+=dt;
    nextObs-=dt; if(nextObs<=0) spawnObstacle();
    nextCoin-=dt; if(nextCoin<=0) spawnCoin();

    obstacles.forEach(o=> o.x -= speed); obstacles = obstacles.filter(o=> o.x+o.w>-10);
    coins.forEach(c=> c.x -= speed); coins = coins.filter(c=> c.x>-20);

    score += speed*0.02; document.getElementById('score').textContent = Math.floor(score);
    kapi.step(dt);

    for(const o of obstacles){
      if(hitRect(o)){ lives-=1; document.getElementById('lives').textContent=lives; o.x-=40; if(lives<=0){ endGame(); break; } }
    }
    for(const c of coins){
      if(!c.taken && hitCoin(c)){ c.taken=true; score+=5; }
    }
    speed += 0.0006*dt;
  }

  ensureClouds(); drawBg(dt); drawGround(); drawCoins(dt); drawObs(); kapi.draw();
  requestAnimationFrame(loop);
}

function start(){
  if(running && !over) return;
  running=true; over=false; score=0; speed=3.0; lives=3;
  obstacles=[]; coins=[]; nextObs=400; nextCoin=600; groundX=0; t=0; lastOnGround=0;
  resetKapi(); document.getElementById('score').textContent="0"; document.getElementById('lives').textContent="3";
  document.getElementById('hint').style.display="none";
}
function endGame(){
  over=true; running=false; best=Math.max(best,Math.floor(score));
  const hint=document.getElementById('hint'); hint.textContent=`üí• Oyun bitti! Skor: ${Math.floor(score)} ‚Ä¢ En iyi: ${best}\nTekrar oynamak i√ßin Ba≈ülat.`; hint.style.display="block";
  try {
  if (tg && typeof tg.sendData === 'function') {
    tg.sendData(JSON.stringify({ type:"runner_score", score: Math.floor(score) }));
  }
} catch(e) {}

}
function tap(){ if(!running || over) start(); else kapi.flap(); }

document.getElementById('btnStart').addEventListener('click', start);
var tapEvent = ('ontouchstart' in window) ? 'touchstart' : (window.PointerEvent ? 'pointerdown' : 'mousedown');
cvs.addEventListener(tapEvent, tap, {passive:true});
document.addEventListener('keydown', e=>{ if(e.code==='Space') tap(); });

resetKapi(); requestAnimationFrame(loop);
</script>
</body>
</html>
