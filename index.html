<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>KAPI RUN</title>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">

  <link rel="manifest" href="appmanifest.json">
  <link rel="apple-touch-icon" sizes="128x128" href="icons/icon-128.png">
  <link rel="apple-touch-icon" sizes="256x256" href="icons/icon-256.png">
  <link rel="icon" type="image/png" href="icons/icon-256.png">

  <link rel="stylesheet" href="style.css">

  <style>
    /* Tam ekran yerleşim – mobilde 100dvh kullan */
    html, body { height:100%; margin:0; background:#000; overflow:hidden; }
    #c3canvas, #c2canvas, canvas,
    #c3canvasdiv, #c2canvasdiv, #construct-root {
      position: fixed;
      inset: 0;
      width: 100vw !important;
      height: 100dvh !important;
      max-width: 100vw;
      max-height: 100dvh;
    }

    /* Canlı $OKAPI rozeti */
    #score-display {
      position: fixed; top: 12px; left: 12px;
      background: rgba(0,0,0,.6); color: #fff;
      padding: 6px 12px; border-radius: 8px;
      font: 700 14px/1.4 system-ui, Arial;
      z-index: 99999; backdrop-filter: blur(2px);
      user-select: none; -webkit-user-select: none;
    }
    /* Büyük ekran butonu */
    #kr-open-browser {
      position: fixed; right: 12px; top: 12px; z-index: 99999;
      padding: 8px 12px; border: 0; border-radius: 10px;
      background: #10b981; color: #081c15; font-weight: 700; font-size: 13px;
      box-shadow: 0 4px 14px rgba(0,0,0,.15); cursor: pointer;
    }
    /* Mobil hızlı test (isteğe bağlı) */
    #kr-debug {
      position: fixed; right: 12px; bottom: 12px; z-index: 99999;
      padding: 10px 14px; border: 0; border-radius: 10px;
      background: #0a84ff; color: #fff; font-size: 14px; display: none;
    }
    /* Tam ekran ipucu */
    #fs-hint {
      position: fixed; inset: 0; display: none; place-items: center; z-index: 99998;
      background: rgba(0,0,0,.55); color: #fff; font: 600 16px/1.6 system-ui, Arial;
      text-align: center; padding: 24px;
    }
  </style>
</head>
<body>
  <!-- Canlı $OKAPI rozeti -->
  <div id="score-display">$OKAPI: 0</div>
  <!-- Büyük ekran butonu -->
  <button id="kr-open-browser">BÜYÜK EKRAN</button>
  <!-- Hızlı test: ?debug=1 ile görünür -->
  <button id="kr-debug">Test Skor (123)</button>
  <!-- Tam ekran ipucu -->
  <div id="fs-hint">Tam ekran için ekrana dokun ya da bir kez tıkla</div>

  <!-- Oyun dosyaların -->
  <script src="scripts/supportcheck.js"></script>
  <script src="scripts/offlineclient.js" type="module"></script>
  <script src="scripts/main.js" type="module"></script>
  <script src="scripts/register-sw.js" type="module"></script>

  <!-- Telegram Games SDK -->
  <script src="https://telegram.org/js/games.js"></script>

  <script>
    // --- Telegram paramları (hash) ---
    const params     = new URLSearchParams(location.hash.slice(1));
    const user_id    = params.get('u');
    const chat_id    = params.get('c');
    const message_id = params.get('m');
    const token      = params.get('t');

    const scoreBox   = document.getElementById('score-display');
    const debugBtn   = document.getElementById('kr-debug');
    const openBtn    = document.getElementById('kr-open-browser');
    const fsHint     = document.getElementById('fs-hint');

    // --- Skor Gönderme (global) ---
    async function submitScore(finalScore, username){
      try{
        if (!user_id || !chat_id || !message_id || !token) {
          console.warn("[KAPI] Not in Telegram context; skipping score submit.");
          return false;
        }
        const res = await fetch('/api/score', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            user_id: Number(user_id),
            chat_id: Number(chat_id),
            message_id: Number(message_id),
            token,
            score: Number(finalScore)||0,
            username: username || null
          })
        });
        const j = await res.json().catch(()=>({}));
        if (!res.ok || !j.ok){ console.error('[KAPI] Score submit failed:', j); return false; }
        console.log('[KAPI] Score submitted:', finalScore);
        return true;
      }catch(e){ console.error('[KAPI] Score submit error:', e); return false; }
    }
    window.submitScore = submitScore;
    window.KAPI_sendScore = submitScore;

    // --- Canlı yazı (global) ---
    let uiScore = 0;
    function updateScore(newScore){
      uiScore = Number(newScore)||0;
      if (scoreBox) scoreBox.textContent = "$OKAPI: " + uiScore;
    }
    window.updateScore = updateScore;

    // --- Otomatik skor tespiti (global değişken adı bilinmiyorsa) ---
    let SCORE_KEY = null;
    window.KAPI_SET_SCORE_KEY = function(k){ SCORE_KEY = k; console.log('[KAPI] SCORE_KEY set:', k); };

    const CANDIDATE_KEYS = ['Score','Skor','Puan','Points','Point','Coin','Coins','OKAPI','Okapi'];
    let lastValues = {}; let lastPeak = 0; let inRun = false; let submitted = false; let idleTicks = 0; let lastShown = -1;

    (function hookC3Runtime(){
      function attachHook(){
        try{
          if (!self.C3_CreateRuntime || self.C3_CreateRuntime.__wrapped) return false;

          const orig = self.C3_CreateRuntime;
          self.C3_CreateRuntime = function(cfg){
            const rt = orig(cfg);
            try{
              window.__c3rt = rt;

              setInterval(()=>{
                const gv = (rt && rt.globalVars) ? rt.globalVars : {};
                let num = NaN;

                if (SCORE_KEY && typeof gv[SCORE_KEY] !== 'undefined'){
                  num = Number(gv[SCORE_KEY]);
                } else {
                  // Aday isimler
                  for (const k of CANDIDATE_KEYS){
                    if (typeof gv[k] !== 'undefined'){
                      const v = Number(gv[k]);
                      if (!Number.isNaN(v)){ num = v; SCORE_KEY = k; break; }
                    }
                  }
                  // Heuristik: artan sayısal değişkeni bul
                  if (Number.isNaN(num)){
                    let bestKey=null,bestDelta=0;
                    for (const [k,vRaw] of Object.entries(gv)){
                      const v = Number(vRaw); if (Number.isNaN(v)) continue;
                      const prev = lastValues[k];
                      const d = (typeof prev==='number') ? (v - prev) : 0;
                      if (d > bestDelta && d < 1e6){ bestDelta=d; bestKey=k; num=v; }
                    }
                    if (bestKey) SCORE_KEY=bestKey;
                  }
                }

                for (const [k,v] of Object.entries(gv)){
                  const n = Number(v); if (!Number.isNaN(n)) lastValues[k]=n;
                }

                if (!Number.isNaN(num) && num !== lastShown){
                  lastShown = num; updateScore(num);
                }

                if (!Number.isNaN(num) && num > 0){ inRun = true; lastPeak = Math.max(lastPeak, num); }

                // GameOver tahmini
                let go=false;
                try{
                  const g = rt.globalVars;
                  go = !!(g && (g.GameOver===1 || g.GameOver===true || g.IsGameOver===1 || g.Game_Over===1 || g.dead===1 || g.Dead===1));
                }catch(_){}

                // idle
                if (!Number.isNaN(num) && num === lastShown) idleTicks++; else idleTicks=0;

                // Gönder
                if (go && inRun && !submitted){ submitted=true; submitScore(lastPeak); }
                if (idleTicks>=10 && inRun && !submitted){ submitted=true; submitScore(lastPeak); } // ~3sn

                // Yeni koşu reset
                if (submitted && (Number.isNaN(num) || num===0)){
                  lastValues={}; lastPeak=0; inRun=false; submitted=false; idleTicks=0; lastShown=-1;
                }
              }, 300);
            }catch(e){ console.warn('[KAPI] hook error', e); }
            return rt;
          };
          self.C3_CreateRuntime.__wrapped = true;
          return true;
        }catch(e){ return false; }
      }
      if (!attachHook()){
        let tries=0; const iv=setInterval(()=>{ tries++; if (attachHook()||tries>50) clearInterval(iv); }, 100);
      }
    })();

    // Masaüstü test: S → 123 skor gönder
    document.addEventListener('keydown', e => { if (e.key.toLowerCase()==='s') submitScore(123); });

    // Mobil: ?debug=1 ile test butonunu göster
    (function showDebugIfRequested(){
      const inTelegram = !!(user_id && chat_id && message_id && token);
      const debug = new URLSearchParams(location.search).get('debug') === '1';
      if (inTelegram && debug && debugBtn){
        debugBtn.style.display='block';
        debugBtn.onclick = async()=>{ const ok=await submitScore(123); alert(ok?'Skor gönderildi ✅':'Gönderilemedi ❌'); };
      }
    })();

    // --- BÜYÜK EKRAN: aynı hash ile yeni sekme + fullscreen ---
    function buildFsUrl(){
      const base = location.origin + location.pathname;
      const qs = new URLSearchParams(location.search);
      qs.set('fs','1'); // fullscreen işareti
      return base + '?' + qs.toString() + location.hash; // HASH AYNI KALIR → skor çalışır
    }
    function openBigScreen(){
      const url = buildFsUrl();
      const win = window.open(url, '_blank', 'noopener');
      if (!win) alert('Yeni sekme engellendi. Lütfen butona tekrar tıklayın veya pop-up izni verin.');
    }
    document.getElementById('kr-open-browser').addEventListener('click', openBigScreen);

    // Yeni sekmede otomatik fullscreen (ilk etkileşimde garanti)
    const wantFs = new URLSearchParams(location.search).get('fs') === '1';
    async function tryFullscreen(){
      const el = document.documentElement;
      if (el.requestFullscreen){
        try { await el.requestFullscreen(); fsHint.style.display='none'; }
        catch(e){ /* jest gerekebilir */ }
      }
    }
    if (wantFs){
      tryFullscreen();                               // hemen dene
      fsHint.style.display='grid';                    // kullanıcıya ipucu
      window.addEventListener('pointerdown', async ()=>{ await tryFullscreen(); }, { once:true });
      document.addEventListener('fullscreenchange', ()=>{
        if (document.fullscreenElement) fsHint.style.display='none';
      });
    }

    // (Opsiyonel) Telegram WebApp görünümü
    if (window.Telegram && Telegram.WebApp) {
      try { Telegram.WebApp.expand(); Telegram.WebApp.ready(); } catch(_){}
    }
  </script>
</body>
</html>
