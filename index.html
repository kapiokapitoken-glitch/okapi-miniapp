<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Kapi Runner ‚Äî Pixel</title>
<style>
  html,body{margin:0;padding:0;background:#0f1226;height:100%;overflow:hidden;font-family:system-ui,Arial}
  #ui{position:fixed;left:0;right:0;top:0;display:flex;align-items:center;justify-content:space-between;padding:8px 12px;color:#fff;z-index:3}
  #left{display:flex;gap:10px;align-items:center}
  .pill{background:rgba(255,255,255,.12);border-radius:999px;padding:6px 10px}
  #btnStart{background:#6c5ce7;border:0;color:#fff;padding:8px 12px;border-radius:10px}
  #hint{position:fixed;left:50%;top:58%;transform:translate(-50%,-50%);color:#fff;opacity:.95;font-size:15px;text-align:center;z-index:2}
  canvas{display:block;touch-action:none}
</style>
</head>
<body>
<div id="ui">
  <div id="left">
    <div class="pill">‚ù§Ô∏è <span id="lives">3</span></div>
    <div class="pill">‚≠ê <span id="score">0</span></div>
  </div>
  <button id="btnStart">Ba≈ülat</button>
</div>
<div id="hint">Dokun / Space: Zƒ±pla ‚¨ÜÔ∏è<br/>Engelleri a≈ü, coin topla!</div>
<canvas id="game"></canvas>

<script>
/* Telegram Mini App */
const tg = window.Telegram?.WebApp; tg?.expand?.();

/* Boyutlandƒ±rma (retina) */
const cvs = document.getElementById("game");
const ctx = cvs.getContext("2d");
function fit(){
  const w = Math.min(window.innerWidth, 420);
  const h = Math.min(window.innerHeight, 780);
  const dpr = window.devicePixelRatio || 1;
  cvs.style.width = w+"px"; cvs.style.height = h+"px";
  cvs.width = Math.floor(w*dpr); cvs.height = Math.floor(h*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.imageSmoothingEnabled = false; // pixel-art netliƒüi
}
fit(); addEventListener("resize", fit);
const W = ()=>cvs.clientWidth, H = ()=>cvs.clientHeight;

/* Oyun state */
let running=false, over=false, score=0, best=0, lives=3;
let speed=3.0, t=0;
let kapi, obstacles=[], coins=[], clouds=[], groundX=0;

/* Fizik sabitleri */
const G = 0.55;      // yer√ßekimi
const JUMP = -9.8;   // zƒ±plama hƒ±zƒ±
const COYOTE = 110;  // ms tolerans
const GROUND_H = 72;
const SPAWN_OBS = [900,1400];
const SPAWN_COIN= [700,1100];

/* Zamanlayƒ±cƒ±lar */
let last = 0, nextObs = 600, nextCoin = 400, lastOnGround = 0;

/* Yardƒ±mcƒ± */
const R = (a,b)=> a + Math.random()*(b-a);
const sleep = ms => new Promise(r=>setTimeout(r,ms));

/* ------- SPRITE AT√ñLYESƒ∞ (Offscreen pixel canvas) ------- */
const PX = 48;  // sprite kaynak boyutu (piksel)
function makePxCanvas(){
  const c = document.createElement("canvas");
  c.width = c.height = PX;
  const p = c.getContext("2d", { alpha: true });
  p.imageSmoothingEnabled = false;
  // pixel grid ile √ßizmek i√ßin kolayla≈ütƒ±rƒ±cƒ±:
  const S = 1; // 1 px
  function rect(x,y,w,h,fill){ p.fillStyle=fill; p.fillRect(Math.round(x),Math.round(y),Math.round(w),Math.round(h)); }
  function circ(x,y,r,fill){ p.fillStyle=fill; p.beginPath(); p.arc(x,y,r,0,Math.PI*2); p.fill(); }
  return {c,p,rect,circ};
}

/* Kapi 4 ko≈üu frame'i (pixel-art) */
function buildKapiFrames(){
  const frames = [];
  for(let i=0;i<4;i++){
    const {c,p,rect,circ} = makePxCanvas();
    p.clearRect(0,0,PX,PX);

    // g√∂vde / kafa (kahverengi tonlarƒ±)
    rect(18,20,20,14,"#8d5a2b"); // g√∂vde
    rect(22,26,12,10,"#c68a53"); // karƒ±n
    rect(30,14,10,10,"#8d5a2b"); // kafa

    // kulak (farklƒ± a√ßƒ±)
    rect(34,8,8,8,"#a56a36");
    rect(33,10,3,4,"#c68a53");

    // g√∂z
    rect(36,16,2,2,"#1b1b1b");

    // kƒ±rmƒ±zƒ± atkƒ± (dalga)
    rect(20,18,16,4,"#e74c3c");
    const wave = [ -5, -2, 1, -3 ][i];
    rect(12,18+wave,10,4,"#e74c3c");

    // kanat (a√ßƒ±sƒ± frame'e g√∂re deƒüi≈üsin)
    const wing = [ -4, 0, 4, 0 ][i];
    rect(18,24+wing,12,6,"#f3c97a");

    // bacaklar (ko≈üu animasyonu)
    const legA = [0,3,6,3][i];
    const legB = [6,3,0,3][i];
    rect(22,33,4,6+legA,"#5d3b1a");
    rect(30,33,4,6+legB,"#5d3b1a");

    frames.push(c);
  }
  return frames;
}

/* Coin 4 frame parƒ±ltƒ± */
function buildCoinFrames(){
  const frames=[];
  for(let i=0;i<4;i++){
    const {c,p,rect,circ} = makePxCanvas();
    p.clearRect(0,0,PX,PX);
    // dƒ±≈ü altƒ±n halka
    circ(24,24,12,"#ffd23f");
    // i√ß parlak √ßizgi (d√∂ner)
    const angle = i*(Math.PI/8)+0.2;
    p.fillStyle="#ffb703";
    p.save(); p.translate(24,24); p.rotate(angle);
    rect(-2,-12,4,24,"#ffb703");
    p.restore();
    frames.push(c);
  }
  return frames;
}

/* Zemin tile */
function buildGroundTile(){
  const {c,p,rect} = makePxCanvas();
  p.clearRect(0,0,PX,PX);
  // toprak
  rect(0,16,48,32,"#693d15");
  // √ßimen
  rect(0,16,48,6,"#2ecc71");
  // ta≈ü doku
  rect(6,34,6,4,"rgba(255,255,255,.06)");
  rect(20,28,8,5,"rgba(255,255,255,.06)");
  rect(32,36,7,5,"rgba(255,255,255,.06)");
  return c;
}

/* Bulut tile */
function buildCloud(){
  const {c,p,circ} = makePxCanvas();
  p.clearRect(0,0,PX,PX);
  p.fillStyle="rgba(255,255,255,.95)";
  circ(18,20,12,"#fff");
  circ(28,22,10,"#fff");
  circ(24,16,9,"#fff");
  return c;
}

/* Sprite seti */
const KAPI_FRAMES = buildKapiFrames();
const COIN_FRAMES = buildCoinFrames();
const TILE_GROUND = buildGroundTile();
const TILE_CLOUD  = buildCloud();

/* Kapi nesnesi */
function resetKapi(){
  kapi = {
    x: 80, y: H()-GROUND_H-42, vy: 0,
    onGround: true, frame:0, ftime:0, scale:2.2,
    flap(){
      const now = performance.now();
      if (this.onGround || (now - lastOnGround)<COYOTE){
        this.vy = JUMP; this.onGround=false;
      }
    },
    step(dt){
      this.vy += G;
      this.y  += this.vy;
      const floor = H()-GROUND_H-42;
      if (this.y >= floor){
        this.y=floor; this.vy=0;
        if (!this.onGround) lastOnGround = performance.now();
        this.onGround=true;
      }
      // animasyon
      this.ftime += dt;
      if (this.ftime>70){ this.ftime=0; this.frame=(this.frame+1)%KAPI_FRAMES.length; }
    },
    draw(){
      const s = this.scale;
      ctx.drawImage(KAPI_FRAMES[this.frame], this.x-24*s/2, this.y-24*s/2, 48*s, 48*s);
    }
  };
}

/* Objeler */
let obstacles=[], coins=[], clouds=[];
function spawnObstacle(){
  const h = R(20,42)*1.2, w = R(22,34)*1.1;
  obstacles.push({ x: W()+30, y: H()-GROUND_H-h, w, h });
  nextObs = R(...SPAWN_OBS);
}
function spawnCoin(){
  const y = H()-GROUND_H - (60 + Math.random()*100);
  coins.push({ x: W()+30, y, r: 10, frame:0, ftime:0, taken:false, scale:1.6 });
  nextCoin = R(...SPAWN_COIN);
}
function ensureClouds(){
  while (clouds.length<6){
    clouds.push({ x: R(0,W()), y: R(30,H()-GROUND_H-180), s: R(.2,.7), w: R(60,140) });
  }
}

/* √áizimler */
function drawBackground(dt){
  // g√∂ky√ºz√º gradyan
  const g = ctx.createLinearGradient(0,0,0,H());
  g.addColorStop(0,"#1a2150"); g.addColorStop(1,"#0f1226");
  ctx.fillStyle=g; ctx.fillRect(0,0,W(),H());

  // bulutlar
  clouds.forEach(c=>{
    c.x -= c.s*speed*0.7;
    if (c.x < -c.w){ c.x = W()+c.w; c.y = R(20,H()-GROUND_H-200); }
    ctx.drawImage(TILE_CLOUD, c.x, c.y, c.w, 38);
  });
}
function drawGround(){
  groundX -= speed*1.2;
  if (groundX <= -24) groundX += 24;
  for (let x=groundX; x<W()+24; x+=24){
    ctx.drawImage(TILE_GROUND, x, H()-GROUND_H, 24, GROUND_H);
  }
}
function drawObstacles(){
  ctx.fillStyle="#27ae60";
  obstacles.forEach(o=>{
    ctx.fillRect(o.x,o.y,o.w,o.h);
    ctx.strokeStyle="#145a32"; ctx.lineWidth=3; ctx.strokeRect(o.x,o.y,o.w,o.h);
  });
}
function drawCoins(dt){
  coins.forEach(c=>{
    if (c.taken) return;
    c.ftime += dt;
    if (c.ftime>90){ c.ftime=0; c.frame=(c.frame+1)%COIN_FRAMES.length; }
    const s = c.scale;
    ctx.drawImage(COIN_FRAMES[c.frame], c.x-24*s/2, c.y-24*s/2, 48*s, 48*s);
  });
}

/* √áarpƒ±≈üma */
function hitRect(o){
  // kaba kutu √ßarpƒ±≈üma
  const rx = kapi.x, ry = kapi.y, rr = 20;
  return (rx + rr > o.x && rx - rr < o.x + o.w && ry + rr > o.y && ry - rr < o.y + o.h);
}
function hitCoin(c){
  const dx = kapi.x - c.x, dy = kapi.y - c.y;
  return (dx*dx + dy*dy) < (22*22);
}

/* Oyun d√∂ng√ºs√º */
function loop(ts){
  if (!last) last = ts;
  const dt = ts - last; last = ts;

  if (running && !over){
    t += dt;

    // spawn
    nextObs -= dt; if (nextObs<=0) spawnObstacle();
    nextCoin -= dt; if (nextCoin<=0) spawnCoin();

    // hareket
    obstacles.forEach(o=> o.x -= speed);
    obstacles = obstacles.filter(o=> o.x + o.w > -10);
    coins.forEach(c=> c.x -= speed);
    coins = coins.filter(c=> c.x > -20);

    // skor (mesafe + coin bonuslarƒ± ayrƒ±ca)
    score += speed*0.02;
    document.getElementById('score').textContent = Math.floor(score);

    // kapi fizik
    kapi.step(dt);

    // √ßarpƒ±≈ümalar
    for (const o of obstacles){
      if (hitRect(o)){
        lives -= 1; document.getElementById('lives').textContent = lives;
        o.x -= 40; // ittir
        if (lives<=0){ endGame(); break; }
      }
    }
    for (const c of coins){
      if (!c.taken && hitCoin(c)){
        c.taken = true; score += 5;
      }
    }

    // dinamik zorluk
    speed += 0.0006*dt;
  }

  // √ßizimler
  ensureClouds(); drawBackground(dt);
  drawGround(); drawCoins(dt); drawObstacles();
  kapi.draw();

  requestAnimationFrame(loop);
}

/* Kontroller */
function start(){
  if (running && !over) return;
  running=true; over=false; score=0; speed=3.0; lives=3;
  obstacles=[]; coins=[]; nextObs=400; nextCoin=600; groundX=0; t=0; lastOnGround=0;
  resetKapi();
  document.getElementById('score').textContent = "0";
  document.getElementById('lives').textContent = "3";
  document.getElementById('hint').style.display="none";
}
function endGame(){
  over=true; running=false;
  best = Math.max(best, Math.floor(score));
  const msg = `üí• Oyun bitti! Skor: ${Math.floor(score)} ‚Ä¢ En iyi: ${best}\nTekrar oynamak i√ßin Ba≈ülat.`;
  const hint = document.getElementById('hint');
  hint.textContent = msg; hint.style.display="block";
  // skoru Telegram'a g√∂nder
  tg?.sendData?.(JSON.stringify({ type:"runner_score", score: Math.floor(score) }));
}
function tap(){ if (!running || over) start(); else kapi.flap(); }

document.getElementById('btnStart').addEventListener('click', start);
cvs.addEventListener('pointerdown', tap);
document.addEventListener('keydown', e=>{ if (e.code==='Space') tap(); });

/* Ba≈ülat */
resetKapi();
requestAnimationFrame(loop);
</script>
</body>
</html>
