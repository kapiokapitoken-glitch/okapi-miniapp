<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Kapi Runner ‚Äî Clean Visuals</title>
<style>
  html,body{margin:0;padding:0;background:#0a0e1a;height:100%;overflow:hidden;font-family:system-ui,Arial}
  #bar{position:fixed;inset:0 0 auto 0;display:flex;justify-content:space-between;align-items:center;padding:8px 12px;color:#fff;z-index:5}
  .left{display:flex;gap:8px;align-items:center}
  .pill{background:rgba(255,255,255,.12);border-radius:999px;padding:6px 10px}
  .btn{background:#5964ff;border:0;color:#fff;padding:8px 12px;border-radius:10px}
  .btn.secondary{background:#313760}
  #hint{position:fixed;left:50%;top:55%;transform:translate(-50%,-50%);color:#fff;font-size:15px;text-align:center;z-index:4;white-space:pre-line;opacity:.95}
  #toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(0,0,0,.6);color:#fff;padding:8px 12px;border-radius:10px;display:none;z-index:6}
  canvas{display:block;touch-action:none}
</style>
</head>
<body>
<div id="bar">
  <div class="left">
    <div class="pill">‚ù§Ô∏è <span id="lives">3</span></div>
    <div class="pill">‚≠ê <span id="score">0</span></div>
    <div class="pill">x<span id="combo">1</span></div>
    <button id="btnHitbox" class="btn secondary" title="Hitboxlarƒ± g√∂ster/gizle">üî≤ Hitbox</button>
    <button id="btnSound" class="btn secondary" title="Sesi a√ß/kapat">üîà Ses</button>
  </div>
  <div class="left">
    <button id="btnPause" class="btn secondary">‚è∏Ô∏è Duraklat</button>
    <button id="btnStart" class="btn">Ba≈ülat</button>
  </div>
</div>
<div id="hint">Dokun / Space: Zƒ±pla ‚¨ÜÔ∏è
Net hitbox‚Äôlar ve temiz g√∂rsellerle oyna.
Coin topla, engellerden ka√ß!</div>
<div id="toast"></div>
<canvas id="cv"></canvas>

<script>
/* ------------------ Hata ekranƒ± (debug) ------------------ */
window.onerror = function (m) {
  const el = document.getElementById('hint');
  if (el) { el.textContent = 'Hata: ' + m; el.style.display='block'; }
};

/* ------------------ Telegram WebApp (iOS uyumlu) ------------------ */
var tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
try { if (tg && typeof tg.expand === 'function') tg.expand(); } catch (e) {}

/* ------------------ Canvas kurulum ------------------ */
const cv = document.getElementById('cv');
const cx = cv.getContext('2d');
function fit(){
  const w = Math.min(innerWidth, 480);
  const h = Math.min(innerHeight, 840);
  const d = devicePixelRatio || 1;
  cv.style.width = w+'px'; cv.style.height = h+'px';
  cv.width = Math.floor(w*d); cv.height = Math.floor(h*d);
  cx.setTransform(d,0,0,d,0,0);
  cx.imageSmoothingEnabled = true; cx.imageSmoothingQuality = 'high';
}
fit(); addEventListener('resize', fit);
const W = ()=>cv.clientWidth, H = ()=>cv.clientHeight;

/* ------------------ Ses ------------------ */
let audioEnabled=false, AC, bipCoin, bipJump, hitS;
function initAudio(){
  try{
    if (AC) return;
    AC = new (window.AudioContext||window.webkitAudioContext)();
    const tone=(f,d,type='sine',g=0.06)=>{
      const o=AC.createOscillator(), gn=AC.createGain();
      o.type=type; o.frequency.value=f; gn.gain.value=g;
      o.connect(gn); gn.connect(AC.destination);
      o.start(); o.stop(AC.currentTime+d);
    };
    bipCoin=()=>tone(1320,0.05,'square',0.05);
    bipJump=()=>tone(880,0.06,'square',0.05);
    hitS=()=>tone(120,0.12,'sawtooth',0.07);
  }catch(e){ audioEnabled=false; }
}

/* ------------------ Yardƒ±mcƒ±lar ------------------ */
const R=(a,b)=>a+Math.random()*(b-a);
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const toast=s=>{const t=document.getElementById('toast');t.textContent=s;t.style.display='block';setTimeout(()=>t.style.display='none',1200);};

/* ------------------ Vekt√∂r ‚Äúsprite‚Äù √ßizimleri ------------------ */
/* Temiz √ßizim i√ßin path ile ≈üekil veriyoruz; sonra offscreen‚Äôe basƒ±p canvas‚Äôa koyuyoruz */
function makeCanvas(w=128,h=128){ const c=document.createElement('canvas'); c.width=w; c.height=h; return c; }

/* OKAPI (Kapi) ‚Äî ger√ßek okapi referansƒ±: koyu kahverengi g√∂vde, beyaz √ßizgili arka bacaklar, kƒ±sa boyun, b√ºy√ºk kulaklar */
function drawOkapi(ctx, t=0){
  ctx.save();
  // g√∂lge
  ctx.globalAlpha=0.25; ctx.fillStyle='#000'; ctx.beginPath();
  ctx.ellipse(64,110,34,10,0,0,Math.PI*2); ctx.fill();
  ctx.globalAlpha=1;

  // g√∂vde
  const bodyGrad = ctx.createLinearGradient(0,0,0,128);
  bodyGrad.addColorStop(0,'#3d2618'); bodyGrad.addColorStop(1,'#6b4124');
  ctx.fillStyle=bodyGrad; ctx.strokeStyle='#1d120c'; ctx.lineWidth=2;

  // g√∂vde ana form
  ctx.beginPath();
  ctx.moveTo(28,72); ctx.quadraticCurveTo(20,60,26,52);
  ctx.lineTo(78,48); ctx.quadraticCurveTo(96,50,100,64);
  ctx.quadraticCurveTo(102,78,88,84);
  ctx.lineTo(42,86); ctx.quadraticCurveTo(30,84,28,72);
  ctx.closePath(); ctx.fill(); ctx.stroke();

  // boyun & kafa
  ctx.beginPath();
  ctx.moveTo(76,50); ctx.quadraticCurveTo(88,42,92,36); // boyun
  ctx.quadraticCurveTo(98,30,102,28); // kafa alt
  ctx.quadraticCurveTo(108,26,106,22); // burun
  ctx.quadraticCurveTo(102,20,96,22);
  ctx.quadraticCurveTo(90,24,86,30);
  ctx.quadraticCurveTo(82,36,76,50);
  ctx.closePath(); ctx.fill(); ctx.stroke();

  // kulaklar
  ctx.fillStyle='#5b3620';
  ctx.beginPath(); ctx.ellipse(94,18,6,10, -0.2, 0, Math.PI*2); ctx.fill(); ctx.strokeStyle='#25160e'; ctx.stroke();
  ctx.beginPath(); ctx.ellipse(84,20,5,9, 0.3, 0, Math.PI*2); ctx.fill(); ctx.stroke();

  // y√ºz ‚Äì g√∂z
  ctx.fillStyle='#111'; ctx.beginPath();
  const blink = Math.sin(t/350) > 0.8;  // arada g√∂z kƒ±rp
  if (blink) { ctx.fillRect(98,26,8,2); }
  else { ctx.ellipse(101,26,2,3,0,0,Math.PI*2); ctx.fill(); }

  // burun parƒ±ltƒ±sƒ±
  ctx.fillStyle='rgba(255,255,255,.25)'; ctx.fillRect(104,22,3,2);

  // bacaklar
  // √∂n bacak
  ctx.lineWidth=3; ctx.strokeStyle='#1d120c';
  ctx.fillStyle='#4a2e1c';
  ctx.beginPath(); ctx.roundRect(46,84,8,28,3); ctx.fill(); ctx.stroke();
  // arka bacak (√ßizgili)
  ctx.fillStyle='#4a2e1c'; ctx.beginPath(); ctx.roundRect(68,84,9,28,3); ctx.fill(); ctx.stroke();
  // zebra ≈üeritleri
  ctx.fillStyle='#e8edf2';
  for (let y=86;y<110;y+=6){ ctx.fillRect(68,y,9,2); }

  // atkƒ± (kƒ±rmƒ±zƒ±) ‚Äì dalgalƒ± hareket
  ctx.fillStyle='#e84141';
  const wave = Math.sin(t/150)*2;
  ctx.fillRect(50,58,24,6);
  ctx.fillRect(36,58+wave,16,6);

  ctx.restore();
}
function okapiSprite(){
  const c=makeCanvas(128,128), p=c.getContext('2d');
  drawOkapi(p, 0);
  return c;
}

/* Coin ‚Äî parlak kenar & parƒ±ltƒ± */
function coinSprite(){
  const c=makeCanvas(80,80), p=c.getContext('2d');
  p.save();
  const g=p.createRadialGradient(40,40,6, 40,40,28);
  g.addColorStop(0,'#ffe082'); g.addColorStop(1,'#ffb300');
  p.fillStyle=g; p.beginPath(); p.arc(40,40,26,0,Math.PI*2); p.fill();
  // parƒ±ltƒ±
  p.globalCompositeOperation='lighter';
  p.fillStyle='rgba(255,255,255,.45)';
  p.beginPath(); p.arc(30,32,10,0,Math.PI*2); p.fill();
  p.restore();
  p.strokeStyle='#5d3b00'; p.lineWidth=3; p.beginPath(); p.arc(40,40,26,0,Math.PI*2); p.stroke();
  return c;
}

/* Engeller: temiz siluet + dƒ±≈ü kontur */
function logSprite(){ // k√ºt√ºk
  const c=makeCanvas(120,80), p=c.getContext('2d');
  p.fillStyle='#8b5a2b'; p.strokeStyle='#3e2814'; p.lineWidth=4;
  p.beginPath(); p.roundRect(6,30,108,26,10); p.fill(); p.stroke();
  // yƒ±llƒ±k halkalar
  p.fillStyle='rgba(255,255,255,.08)';
  p.beginPath(); p.arc(24,43,10,0,Math.PI*2); p.fill();
  return c;
}
function bushSprite(){ // √ßalƒ±
  const c=makeCanvas(110,90), p=c.getContext('2d');
  p.fillStyle='#2ecc71'; p.strokeStyle='#145a32'; p.lineWidth=4;
  p.beginPath(); p.moveTo(10,70);
  p.quadraticCurveTo(30,40,50,60);
  p.quadraticCurveTo(70,30,90,50);
  p.quadraticCurveTo(100,65,96,70);
  p.lineTo(10,70); p.fill(); p.stroke();
  return c;
}
function rockSprite(){ // kaya
  const c=makeCanvas(90,100), p=c.getContext('2d');
  p.fillStyle='#9aa7b1'; p.strokeStyle='#5a646d'; p.lineWidth=4;
  p.beginPath(); p.moveTo(10,90);
  p.lineTo(30,30); p.lineTo(70,20); p.lineTo(82,60); p.lineTo(75,90);
  p.closePath(); p.fill(); p.stroke();
  return c;
}

/* Arka plan d√∂≈üemeleri */
function groundTile(){
  const c=makeCanvas(64,64), p=c.getContext('2d');
  p.fillStyle='#6e4b2e'; p.fillRect(0,40,64,24);
  p.fillStyle='#1fab61'; p.fillRect(0,38,64,6);
  return c;
}
function cloudTile(){
  const c=makeCanvas(128,64), p=c.getContext('2d');
  p.fillStyle='rgba(255,255,255,.95)';
  p.beginPath(); p.arc(30,36,18,0,Math.PI*2); p.fill();
  p.beginPath(); p.arc(54,28,20,0,Math.PI*2); p.fill();
  p.beginPath(); p.arc(78,36,18,0,Math.PI*2); p.fill();
  return c;
}

/* Offscreen sprite‚Äôlarƒ± hazƒ±rla */
const SPR_OKAPI = okapiSprite();
const SPR_COIN  = coinSprite();
const SPR_LOG   = logSprite();
const SPR_BUSH  = bushSprite();
const SPR_ROCK  = rockSprite();
const TILE_G    = groundTile();
const TILE_CLOUD= cloudTile();

/* ------------------ Oyun state ------------------ */
let running=false, paused=false, over=false;
let score=0, best=0, lives=3, combo=1, comboTimer=0;
let speed=3.1, t=0, groundX=0;
let last=0, nextObs=600, nextCoin=400, lastOnGround=0;
let hitFlash=0, shake=0;
let showHitbox=false;

const G=0.56, JUMP=-10.1, COYOTE=120, GROUND_H=84;
const SPAWN_OBS=[900,1400], SPAWN_COIN=[600,1000];

let kapi, obstacles=[], coins=[], clouds=[];

/* Kapi objesi (dairesel hitbox; g√∂rsel ile hizalƒ±) */
function resetKapi(){
  kapi={
    x: 92, y: H()-GROUND_H-56, vy:0, onGround:true,
    r: 24, // hitbox yarƒ±√ßapƒ±
    step(dt){
      this.vy+=G; this.y+=this.vy;
      const floor=H()-GROUND_H-56;
      if (this.y>=floor){ this.y=floor; this.vy=0; if(!this.onGround) lastOnGround=performance.now(); this.onGround=true; }
    },
    flap(){
      const now=performance.now();
      if (this.onGround || (now-lastOnGround)<COYOTE){ this.vy=JUMP; this.onGround=false; if(audioEnabled) bipJump(); }
    },
    draw(){
      // hitbox (debug)
      if (showHitbox){
        cx.strokeStyle='rgba(0,255,255,.7)'; cx.lineWidth=2;
        cx.beginPath(); cx.arc(this.x,this.y,this.r,0,Math.PI*2); cx.stroke();
      }
      cx.drawImage(SPR_OKAPI, this.x-64, this.y-64, 128,128);
    }
  };
}

/* Spawn fonksiyonlarƒ± */
function spawnObstacle(){
  const roll=Math.random();
  let spr, w, h, offY=0, type='log';
  if (roll<0.34){ spr=SPR_LOG; w=120; h=50; offY=H()-GROUND_H-h; type='log'; }
  else if (roll<0.67){ spr=SPR_BUSH; w=110; h=70; offY=H()-GROUND_H-h; type='bush'; }
  else { spr=SPR_ROCK; w=90; h=90; offY=H()-GROUND_H-h; type='rock'; }
  obstacles.push({x:W()+40,y:offY,w,h,spr,type,
    aabb:{x:0,y:0,w:0,h:0} // √ßarpƒ±≈üma kutusu (hesaplanacak)
  });
  nextObs=R(SPAWN_OBS[0],SPAWN_OBS[1]);
}
function spawnCoin(){
  const y = H()-GROUND_H - R(80,160);
  coins.push({x:W()+30, y, r:14, spr:SPR_COIN, taken:false});
  nextCoin=R(SPAWN_COIN[0],SPAWN_COIN[1]);
}
function ensureClouds(){ while(clouds.length<6){ clouds.push({x:R(0,W()), y:R(20,H()-GROUND_H-220), w:R(100,180), s:R(.25,.55)}); } }

/* √áarpƒ±≈üma yardƒ±mcƒ±larƒ± */
function circleAABB(cx,cy,cr, box){
  // box: {x,y,w,h}
  const nx=clamp(cx, box.x, box.x+box.w);
  const ny=clamp(cy, box.y, box.y+box.h);
  const dx=cx-nx, dy=cy-ny;
  return (dx*dx+dy*dy) <= cr*cr;
}

/* Parallax & zemin */
function drawBackground(){
  const g=cx.createLinearGradient(0,0,0,H());
  g.addColorStop(0,'#111a36'); g.addColorStop(1,'#0a0e1a');
  cx.fillStyle=g; cx.fillRect(0,0,W(),H());

  // bulutlar
  clouds.forEach(c=>{
    c.x-=c.s*speed*0.7; if (c.x<-c.w){ c.x=W()+c.w; c.y=R(20,H()-GROUND_H-200); }
    cx.drawImage(TILE_CLOUD, c.x, c.y, c.w, c.w*0.5);
  });
}
function drawGround(){
  groundX-=speed*1.2; if(groundX<=-64) groundX+=64;
  for(let x=groundX;x<W()+64;x+=64) cx.drawImage(TILE_G, x, H()-GROUND_H, 64,64);
}

/* Ana d√∂ng√º */
function loop(ts){
  if(!last) last=ts;
  const rawDt = ts-last; last=ts;
  const dt = Math.min(50, rawDt);

  if (shake>0) shake-=dt;
  const sx = (shake>0)? R(-4,4):0, sy = (shake>0)? R(-2,2):0;
  cx.save(); cx.translate(sx,sy);

  if (running && !paused && !over){
    t+=dt;
    nextObs-=dt; if(nextObs<=0) spawnObstacle();
    nextCoin-=dt; if(nextCoin<=0) spawnCoin();

    obstacles.forEach(o=>o.x-=speed);
    obstacles = obstacles.filter(o=>o.x+o.w>-20);
    coins.forEach(c=>c.x-=speed);
    coins = coins.filter(c=>c.x>-20);

    // √ßarpƒ±≈üma kutularƒ±nƒ± engel sprite'larƒ±na g√∂re sƒ±kƒ±la≈ütƒ±r
    obstacles.forEach(o=>{
      // her sprite i√ßin g√∂zle ayarlanmƒ±≈ü aabb (g√∂rselle daha uyumlu)
      if (o.type==='log'){ o.aabb={x:o.x+10,y:o.y+8,w:o.w-20,h:o.h-12}; }
      else if (o.type==='bush'){ o.aabb={x:o.x+12,y:o.y+10,w:o.w-22,h:o.h-18}; }
      else { o.aabb={x:o.x+10,y:o.y+10,w:o.w-20,h:o.h-20}; }
    });

    // karakter
    kapi.step(dt);
    score += speed*0.02;
    comboTimer -= dt; if (comboTimer<=0) combo=1;

    // coin toplama (√ßarpma anƒ±nda parƒ±ltƒ± + ses)
    for (const c of coins){
      if (!c.taken){
        const dx=kapi.x-c.x, dy=kapi.y-c.y;
        if (dx*dx+dy*dy < (kapi.r+c.r)*(kapi.r+c.r)){
          c.taken=true;
          const add = 6*combo; score+=add;
          combo = clamp(combo+0.25, 1, 5); comboTimer=1800;
          if (audioEnabled) bipCoin();
        }
      }
    }

    // engel √ßarpƒ±≈üma (net geri bildirim: ekran titremesi + kƒ±rmƒ±zƒ± flash)
    for (const o of obstacles){
      if (circleAABB(kapi.x, kapi.y, kapi.r*0.92, o.aabb)){
        lives -= 1; document.getElementById('lives').textContent=Math.max(0,lives);
        hitFlash = 220; shake=260;
        if (audioEnabled) hitS();
        o.x -= 60; // it
        if (lives<=0){ endGame(); break; }
      }
    }

    // zorluk artƒ±≈üƒ±
    speed += 0.00045*dt;

    // skor-paneller
    document.getElementById('score').textContent = Math.floor(score);
    document.getElementById('combo').textContent = Math.floor(combo);
  }

  // √áƒ∞Zƒ∞M
  drawBackground();
  drawGround();

  // coinler
  coins.forEach(c=>{
    cx.drawImage(SPR_COIN, c.x-40, c.y-40, 80,80);
    if (showHitbox){
      cx.strokeStyle='rgba(255,255,0,.7)'; cx.beginPath(); cx.arc(c.x,c.y,c.r,0,Math.PI*2); cx.stroke();
    }
  });

  // engeller
  obstacles.forEach(o=>{
    cx.drawImage(o.spr, o.x, o.y, o.w, o.h);
    if (showHitbox){
      cx.strokeStyle='rgba(255,0,0,.7)'; cx.lineWidth=2; cx.strokeRect(o.aabb.x,o.aabb.y,o.aabb.w,o.aabb.h);
    }
  });

  // karakter
  kapi.draw();

  // √ßarpma ‚Äúflash‚Äù overlay
  if (hitFlash>0){
    hitFlash-=dt;
    cx.globalAlpha = Math.max(0, hitFlash/220)*0.6;
    cx.fillStyle='#ff3344'; cx.fillRect(0,0,W(),H());
    cx.globalAlpha=1;
  }

  cx.restore();
  requestAnimationFrame(loop);
}

/* Ba≈ülat/Biti≈ü/Pause */
function startGame(){
  running=true; paused=false; over=false;
  score=0; lives=3; combo=1; comboTimer=0; speed=3.1;
  obstacles=[]; coins=[]; clouds=[]; groundX=0; t=0; lastOnGround=0; hitFlash=0; shake=0;
  ensureClouds(); resetKapi();
  document.getElementById('score').textContent='0';
  document.getElementById('lives').textContent='3';
  document.getElementById('combo').textContent='1';
  document.getElementById('hint').style.display='none';
}
function endGame(){
  over=true; running=false;
  best = Math.max(best, Math.floor(score));
  const msg = "üí• Oyun bitti! Skor: " + Math.floor(score) + " ‚Ä¢ En iyi: " + best + "\nTekrar i√ßin Ba≈ülat.";
  const hint = document.getElementById('hint'); hint.textContent = msg; hint.style.display='block';
  try{ if (tg && typeof tg.sendData==='function') tg.sendData(JSON.stringify({type:"runner_score",score:Math.floor(score)})); }catch(e){}
}
function togglePause(){
  if (!running || over) return;
  paused=!paused;
  document.getElementById('btnPause').textContent = paused ? "‚ñ∂Ô∏è Devam" : "‚è∏Ô∏è Duraklat";
  toast(paused ? "Duraklatƒ±ldƒ±" : "Devam");
}
function tap(ev){
  try{ if (ev && typeof ev.preventDefault==='function') ev.preventDefault(); }catch(_){}
  if (!running || over) startGame(); else if (!paused) kapi.flap();
}

/* Etkinlikler (iOS uyumlu) */
(function bind(){
  const tapEvent = ('ontouchstart' in window) ? 'touchstart' : (window.PointerEvent ? 'pointerdown' : 'mousedown');
  cv.addEventListener(tapEvent, tap, {passive:false});
  document.addEventListener('keydown', e=>{ if(e.code==='Space') tap(e); else if (e.code==='KeyP') togglePause(); });

  document.getElementById('btnStart').addEventListener('click', ()=>{ startGame(); if(audioEnabled){ initAudio(); bipJump(); } });
  document.getElementById('btnPause').addEventListener('click', togglePause);
  document.getElementById('btnSound').addEventListener('click', ()=>{ audioEnabled=!audioEnabled; if(audioEnabled) initAudio(); toast(audioEnabled?"üîä Ses a√ßƒ±k":"üîá Ses kapalƒ±"); });
  document.getElementById('btnHitbox').addEventListener('click', ()=>{ showHitbox=!showHitbox; toast(showHitbox?"üî≤ Hitbox ON":"üî≤ Hitbox OFF"); });
})();

/* Ba≈ülat */
resetKapi();
requestAnimationFrame(loop);
</script>
</body>
</html>
