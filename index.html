<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>KAPI RUN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">

  <link rel="manifest" href="appmanifest.json">
  <link rel="apple-touch-icon" sizes="128x128" href="icons/icon-128.png">
  <link rel="apple-touch-icon" sizes="256x256" href="icons/icon-256.png">
  <link rel="icon" type="image/png" href="icons/icon-256.png">

  <link rel="stylesheet" href="style.css">

  <style>
    /* Skor rozeti (canlƒ± g√∂sterim) */
    #score-display {
      position: fixed; top: 12px; left: 12px;
      background: rgba(0,0,0,.6); color: #fff;
      padding: 6px 12px; border-radius: 8px;
      font: 700 14px/1.4 system-ui, Arial;
      z-index: 99999;
      backdrop-filter: blur(2px);
    }

    /* Alt sabit UI konteyneri */
    #ui-container {
      position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%);
      display: flex; gap: 12px; z-index: 99999; flex-wrap: wrap;
    }
    .ui-btn {
      padding: 10px 16px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      cursor: pointer;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      transition: transform .18s ease, box-shadow .18s ease, opacity .18s ease;
      opacity: .98;
    }
    .ui-btn:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 6px 16px rgba(0,0,0,.35); opacity: 1; }
    #btn-play {
      background: linear-gradient(135deg, #2ecc71, #27ae60); color: #fff;
    }
    #btn-leaderboard {
      background: linear-gradient(135deg, #3a3a3a, #1f1f1f); color: #fff;
    }

    /* Leaderboard popup */
    #leaderboard{
      position:fixed; left:50%; top:10%; transform:translateX(-50%);
      background:rgba(0,0,0,.85); color:#fff; padding:16px 20px;
      border-radius:14px; font:14px/1.45 system-ui,Arial;
      max-width:90vw; z-index:99998; display:none; min-width:260px;
      box-shadow: 0 10px 30px rgba(0,0,0,.45);
    }
    #leaderboard h3{margin:0 0 10px; font-size:18px}
    #leaderboard ol{margin:0; padding-left:22px; max-height:50vh; overflow:auto}
    #leaderboard .close{position:absolute; right:10px; top:8px; cursor:pointer; font-size:18px; opacity:.9}
    #leaderboard .close:hover{opacity:1}

    /* Mobil iyile≈ütirmeler */
    @media (max-width: 500px) {
      #ui-container { flex-direction: column; bottom: 10px; }
      .ui-btn { width: calc(100vw - 32px); }
    }
  </style>
</head>
<body>
  <div id="fb-root"></div>

  <!-- Canlƒ± skor rozeti -->
  <div id="score-display">Score: 0</div>

  <!-- Oyun dosyalarƒ±n -->
  <script src="scripts/supportcheck.js"></script>
  <script src="scripts/offlineclient.js" type="module"></script>
  <script src="scripts/main.js" type="module"></script>
  <script src="scripts/register-sw.js" type="module"></script>

  <!-- Telegram Games SDK -->
  <script src="https://telegram.org/js/games.js"></script>

  <!-- Alt sabit UI butonlarƒ± -->
  <div id="ui-container">
    <button id="btn-play" class="ui-btn">‚ñ∂Ô∏è Play KAPI RUN</button>
    <button id="btn-leaderboard" class="ui-btn">üèÜ Leaderboard</button>
  </div>

  <!-- Leaderboard popup -->
  <div id="leaderboard">
    <span class="close" onclick="this.parentNode.style.display='none'">‚úï</span>
    <h3>üèÜ Leaderboard</h3>
    <ol id="lb-list"></ol>
  </div>

  <!-- (ƒ∞steƒüe baƒülƒ±) Tƒ±k sesi: sounds/click.mp3 dosyasƒ±nƒ± eklersen aktif olur -->
  <audio id="click-sound" src="sounds/click.mp3" preload="auto"></audio>

  <script>
    // URL fragment (#u=...&c=...&m=...&t=...) i√ßinden parametreleri al
    const params = new URLSearchParams(location.hash.slice(1));
    const user_id    = params.get('u');
    const chat_id    = params.get('c');
    const message_id = params.get('m');
    const token      = params.get('t');

    const scoreBox = document.getElementById('score-display');
    const clickSfx = document.getElementById('click-sound');

    // ----- Skor g√∂nderme -----
    async function submitScore(finalScore) {
      try {
        if (!user_id || !chat_id || !message_id || !token) {
          console.warn("Not in Telegram context; skipping score submit.");
          return;
        }
        const res = await fetch('/api/score', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ user_id, chat_id, message_id, token, score: Number(finalScore)||0 })
        });
        const j = await res.json().catch(() => ({}));
        if (!res.ok || !j.ok) console.error('Score submit failed:', j);
        else alert("Game Over! Skorun: " + (Number(finalScore)||0) + " ‚úÖ");
      } catch (e) {
        console.error('Score submit error:', e);
      }
    }
    window.submitScore = submitScore; // global eri≈üim

    // ----- Canlƒ± skor UI g√ºncelleme -----
    let score = 0;
    function updateScore(newScore){
      score = Number(newScore) || 0;
      if (scoreBox) scoreBox.textContent = "Score: " + score;
    }
    window.updateScore = updateScore; // oyunun i√ßinden √ßaƒüƒ±r: updateScore(x)

    // ----- Leaderboard -----
    async function showLeaderboard(){
      if (!chat_id || !message_id) { console.warn('LB: not in Telegram context'); return; }
      try{
        const res = await fetch(`/api/highscores?chat_id=${chat_id}&message_id=${message_id}`);
        const j = await res.json();
        if (!j.ok) throw new Error('highscores not ok');
        const list = document.getElementById('lb-list');
        list.innerHTML = '';
        j.items.forEach(row => {
          const li = document.createElement('li');
          // ƒ∞lk 3'e madalya
          let medal = "";
          if (row.pos === 1) medal = "ü•á ";
          else if (row.pos === 2) medal = "ü•à ";
          else if (row.pos === 3) medal = "ü•â ";
          li.textContent = `${medal}${row.pos}. ${row.name} ‚Äî ${row.score}`;
          list.appendChild(li);
        });
        document.getElementById('leaderboard').style.display = 'block';
      }catch(e){
        console.error('LB error', e);
      }
    }
    window.showLeaderboard = showLeaderboard;

    // ----- Buton davranƒ±≈ülarƒ± -----
    document.getElementById('btn-play').onclick = () => {
      try { clickSfx && clickSfx.play().catch(()=>{}); } catch(_) {}
      // Oyunu ba≈ülat/yeniden ba≈ülat. Kendi oyun start fonksiyonunu biliyorsan burada √ßaƒüƒ±r.
      location.reload(); // basit ve garanti √ß√∂z√ºm
    };
    document.getElementById('btn-leaderboard').onclick = () => {
      try { clickSfx && clickSfx.play().catch(()=>{}); } catch(_) {}
      showLeaderboard();
    };

    // ----- Klavye kƒ±sayollarƒ± (hƒ±zlƒ± test) -----
    document.addEventListener('keydown', e => {
      const k = e.key.toLowerCase();
      if (k === 's') submitScore(123);   // S: test skoru g√∂nder
      if (k === 'l') showLeaderboard();  // L: leaderboard a√ß
    });

    // (Opsiyonel) Telegram WebApp g√∂r√ºn√ºm√º uyumu
    if (window.Telegram && Telegram.WebApp) {
      Telegram.WebApp.expand();
      Telegram.WebApp.ready();
    }
  </script>
</body>
</html>
